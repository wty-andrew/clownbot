<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/clownbot/blog/rss.xml" title="Clownbot Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/clownbot/blog/atom.xml" title="Clownbot Blog Atom Feed">
<link rel="stylesheet" href="/clownbot/css/katex.min.css"><title data-react-helmet="true">Testing Setup | Clownbot</title><meta data-react-helmet="true" property="og:title" content="Testing Setup | Clownbot"><meta data-react-helmet="true" name="description" content="It seems the roslisptesting package mentioned in ros wiki no longer exist anymore. However, the wiki page provide detailed enough information so we can roll our own solution, here are some notes taken while trying to replicate the functionality."><meta data-react-helmet="true" property="og:description" content="It seems the roslisptesting package mentioned in ros wiki no longer exist anymore. However, the wiki page provide detailed enough information so we can roll our own solution, here are some notes taken while trying to replicate the functionality."><meta data-react-helmet="true" property="og:url" content="https://wty-andrew.github.io/clownbot/blog/2020/05/10/testing-setup"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/clownbot/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://wty-andrew.github.io/clownbot/blog/2020/05/10/testing-setup"><link data-react-helmet="true" rel="alternate" href="https://wty-andrew.github.io/clownbot/blog/2020/05/10/testing-setup" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wty-andrew.github.io/clownbot/blog/2020/05/10/testing-setup" hreflang="x-default"><link rel="stylesheet" href="/clownbot/assets/css/styles.7209c2e9.css">
<link rel="preload" href="/clownbot/assets/js/runtime~main.22bc7103.js" as="script">
<link rel="preload" href="/clownbot/assets/js/main.a805163a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/clownbot/"><strong class="navbar__title">Clownbot</strong></a><a class="navbar__item navbar__link" href="/clownbot/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/clownbot/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wty-andrew/clownbot" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/clownbot/"><strong class="navbar__title">Clownbot</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/clownbot/docs">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/clownbot/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/wty-andrew/clownbot" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/clownbot/blog/2020/05/10/testing-setup">Testing Setup</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Testing Setup</h1><div class="margin-vert--md"><time datetime="2020-05-10T00:00:00.000Z" class="blogPostDate_fNvV">May 10, 2020 Â· 5 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><div class="markdown"><p>It seems the <code>roslisp_testing</code> package mentioned in <a href="http://wiki.ros.org/roslisp_support/Tutorials/UnitTestingwithRT" target="_blank" rel="noopener noreferrer">ros wiki</a> no longer exist anymore. However, the wiki page provide detailed enough information so we can roll our own solution, here are some notes taken while trying to replicate the functionality.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="integration-with-rostest"></a>Integration with Rostest<a class="hash-link" href="#integration-with-rostest" title="Direct link to heading">#</a></h2><p>In order to make our own test compliant with rostest, we need to convert the test result into google test compatible format, which actually uses the JUnit XML format<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.</p><p>The <a href="http://wiki.ros.org/roslisp_support/Tutorials/UnitTestingwithRT#Other_test_frameworks" target="_blank" rel="noopener noreferrer">wiki</a> page already provide the structure templates and the function signature of the entry point</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lisp"><div tabindex="0" class="prism-code language-lisp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">(defstruct gtestfailure</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  type ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  message ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  )</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">(defstruct gtestcase</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  classname ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  name ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  time ;; float</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  failures ;; list of gtestfailure</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  )</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">(defstruct gtestsuite</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  name ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  time ;; float</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  testcases ;; list of gtestcase</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  sysout ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  syserr ;; string</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  )</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">(defun run-suites-write-gtest-file (posix-args suite-fun transform-fun)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  ...)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To fill in the <code>run-suites-write-gtest-file</code>, we need a function to convert the structures to something like below</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><div tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag" style="color:#fc929e">testsuites</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#8dc891">=</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag attr-value" style="color:#8dc891">AllTests</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">...</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag" style="color:#fc929e">testsuite</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#8dc891">=</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag attr-value" style="color:#8dc891">test_case_name</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">...</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag" style="color:#fc929e">testcase</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#8dc891">=</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag attr-value" style="color:#8dc891">test_name</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">...</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag" style="color:#fc929e">failure</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">message</span><span class="token tag attr-value punctuation attr-equals" style="color:#8dc891">=</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag attr-value" style="color:#8dc891">...</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag punctuation" style="color:#8dc891">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag" style="color:#fc929e">failure</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">message</span><span class="token tag attr-value punctuation attr-equals" style="color:#8dc891">=</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag attr-value" style="color:#8dc891">...</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag punctuation" style="color:#8dc891">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag" style="color:#fc929e">failure</span><span class="token tag" style="color:#fc929e"> </span><span class="token tag attr-name" style="color:#c5a5c5">message</span><span class="token tag attr-value punctuation attr-equals" style="color:#8dc891">=</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag attr-value" style="color:#8dc891">...</span><span class="token tag attr-value punctuation" style="color:#8dc891">&quot;</span><span class="token tag punctuation" style="color:#8dc891">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token tag punctuation" style="color:#8dc891">&lt;/</span><span class="token tag" style="color:#fc929e">testcase</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token tag punctuation" style="color:#8dc891">&lt;/</span><span class="token tag" style="color:#fc929e">testsuite</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token tag punctuation" style="color:#8dc891">&lt;/</span><span class="token tag" style="color:#fc929e">testsuites</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>and a function to find out xml output path from <code>posix-args</code> (rostest will pass it through the <code>--gtest_output</code> flag).</p><p><code>suite-fun</code> and <code>tranform-fun</code> are customized functions for the testing framework being used</p><ul><li><code>suite-fun</code> runs the tests and returns a test result object</li><li><code>tranform-fun</code> converts the test result object into the <code>gtestsuite</code> structure</li></ul><p>A minimal implementation for <code>run-suites-write-gtest-file</code> would be</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lisp"><div tabindex="0" class="prism-code language-lisp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">(defun run-suites-write-gtest-file (posix-args suite-fun transform-fun)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  (let* ((output-path (find-gtest-output-path posix-args)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">         (test-results (funcall suite-fun))</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">         (gtest-results (funcall transform-fun test-results))</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    (with-open-file (*standard-output* output-path :direction :output</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">                                                   :if-exists :supersede)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">      (gtest-&gt;xml gtest-results))))))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For a practical example, suppose we want to run it with <a href="https://github.com/OdonataResearchLLC/lisp-unit" target="_blank" rel="noopener noreferrer">lisp-unit</a>, <code>suite-fun</code> will be the function to run the tests: <code>(lambda () (lisp-unit:run-tests :all :my-package))</code>, <code>transform-fun</code> can be implemented by converting the following objects</p><table><thead><tr><th>lisp-unit</th><th>gtest</th></tr></thead><tbody><tr><td><code>failure</code></td><td><code>gtestfailure</code></td></tr><tr><td><code>test-result</code></td><td><code>gtestcase</code></td></tr><tr><td><code>test-results-db</code></td><td><code>gtestsuite</code></td></tr></tbody></table><p>the one-to-one correspondence is not a coincidence since <a href="https://github.com/OdonataResearchLLC/lisp-unit" target="_blank" rel="noopener noreferrer">lisp-unit</a> claimed to be inspired by JUnit, the <code>transform-fun</code> happened to be quite trivial in this case.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="executable-script"></a>Executable Script<a class="hash-link" href="#executable-script" title="Direct link to heading">#</a></h2><p>The ros wiki page on <a href="http://wiki.ros.org/roslisp/Tutorials/OrganizingFiles" target="_blank" rel="noopener noreferrer">organizing files for roslisp</a> have thorough information on creating lisp executable scripts, the easiest way is to use the cmake function</p><div class="codeBlockContainer_K1bP"><div style="background-color:#282c34;color:#ffffff" class="codeBlockTitle_eoMF">catkin_ws/src/my_package/CMakeLists.txt</div><div class="codeBlockContent_hGly cmake"><div tabindex="0" class="prism-code language-cmake codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain"># the function arguments are output, system_name, and entry_point respectively</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">add_lisp_executable(my_node my-system my-package:my-func)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>which should generate the following script</p><div class="codeBlockContainer_K1bP"><div style="background-color:#282c34;color:#ffffff" class="codeBlockTitle_eoMF">catkin_ws/devel/lib/my_package/my_node</div><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token shebang important" style="color:#999999;font-weight:400">#!/usr/bin/env sh</span><span class="token plain"></span></div><div class="token-line docusaurus-highlight-code-line" style="color:#ffffff"><span class="token plain"></span><span class="token string" style="color:#8dc891">&quot;true&quot;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:#FAC863">exec</span><span class="token plain"> /usr/bin/env sbcl --noinform --load /opt/ros/melodic/share/roslisp/scripts/roslisp-sbcl-init --script </span><span class="token string" style="color:#8dc891">&quot;</span><span class="token string variable" style="color:#d7deea">$0</span><span class="token string" style="color:#8dc891">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;</span><span class="token string variable" style="color:#d7deea">$@</span><span class="token string" style="color:#8dc891">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">ros-load:load-system </span><span class="token string" style="color:#8dc891">&quot;my_package&quot;</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;my-system&quot;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">my-package:my-func</span><span class="token punctuation" style="color:#8dc891">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The script will first be run by shell and then <code>sbcl</code>, the highlighted line shows a clever trick, <code>&quot;true&quot;</code> and the semicolon are both valid syntax for <code>sh</code> and <code>sbcl</code>, <code>sbcl</code> ignores shebang by default so the entire script is a valid lisp script (<code>&quot;true&quot;</code> just evaluates to a string which does no harm).</p><p>Another trick found from <a href="https://github.com/roswell/roswell" target="_blank" rel="noopener noreferrer">roswell</a> uses block comments, in addition, the mode line will inform emacs to choose the correct mode for editing</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token shebang important" style="color:#999999;font-weight:400">#!/usr/bin/env sh</span><span class="token plain"></span></div><div class="token-line docusaurus-highlight-code-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">#|-*- mode:lisp -*-|#</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">#|</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token builtin class-name" style="color:#FAC863">exec</span><span class="token plain"> /usr/bin/env sbcl --noinform --script </span><span class="token string" style="color:#8dc891">&quot;</span><span class="token string variable" style="color:#d7deea">$0</span><span class="token string" style="color:#8dc891">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;</span><span class="token string variable" style="color:#d7deea">$@</span><span class="token string" style="color:#8dc891">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">|</span><span class="token comment" style="color:#999999">#</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now back to the lisp executable script, notice there&#x27;s only a single entry function that takes no arguments, so a wrapper function is required if we are going to run <code>run-suites-write-gtest-file</code>. The other problem is <code>sbcl</code> does not load <code>.sbclrc</code> when running with <code>--script</code> option (according to <a href="https://stackoverflow.com/questions/9229526" target="_blank" rel="noopener noreferrer">this discussion</a> on stackoverflow), we have to load <code>quicklisp</code> ourselves in order to use external libraries.</p><p>Here&#x27;s the final modified template for lisp executable script</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token shebang important" style="color:#999999;font-weight:400">#!/usr/bin/env sh</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">#|-*- mode:lisp -*-|#</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">#|</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token builtin class-name" style="color:#FAC863">exec</span><span class="token plain"> /usr/bin/env sbcl --noinform </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">                       --load </span><span class="token variable" style="color:#d7deea">$(</span><span class="token variable" style="color:#d7deea">rospack </span><span class="token variable function" style="color:#79b6f2">find</span><span class="token variable" style="color:#d7deea"> roslisp</span><span class="token variable" style="color:#d7deea">)</span><span class="token plain">/scripts/roslisp-sbcl-init </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">                       --load </span><span class="token environment constant" style="color:#5a9bcf">$HOME</span><span class="token plain">/quicklisp/setup.lisp </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain">                       --script </span><span class="token string" style="color:#8dc891">&quot;</span><span class="token string variable" style="color:#d7deea">$0</span><span class="token string" style="color:#8dc891">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;</span><span class="token string variable" style="color:#d7deea">$@</span><span class="token string" style="color:#8dc891">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">|</span><span class="token comment" style="color:#999999">#</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">ros-load:load-system </span><span class="token string" style="color:#8dc891">&quot;my_package&quot;</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;my-system&quot;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">my-package:my-func</span><span class="token punctuation" style="color:#8dc891">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To automate the script generation process, the <code>add_lisp_executable</code> function (see <a href="https://github.com/ros/roslisp/blob/master/cmake/roslisp-extras.cmake.em" target="_blank" rel="noopener noreferrer">roslisp-extras.cmake.em</a>) is copied and named <code>add_lisp_script</code> in the project.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="integration-with-catkin"></a>Integration with Catkin<a class="hash-link" href="#integration-with-catkin" title="Direct link to heading">#</a></h2><p>It would be great if our lisp test can be invoked automatically when running the <code>catkin_make run_tests</code> command, this is done in python and C++ through the <a href="https://github.com/ros/catkin/blob/noetic-devel/cmake/test/nosetests.cmake" target="_blank" rel="noopener noreferrer">catkin_add_nosetests</a> and <a href="https://github.com/ros/catkin/blob/noetic-devel/cmake/test/gtest.cmake" target="_blank" rel="noopener noreferrer">catkin_add_gmock</a> cmake function, they use the internal function <code>catkin_run_tests_target</code> to add in the dependency.</p><p>Combined with the <code>add_lisp_script</code> from the above section, here&#x27;s the new <code>catkin_add_lisptests</code> cmake function</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cmake"><div tabindex="0" class="prism-code language-cmake codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">_generate_function_if_testing_is_disabled(&quot;catkin_add_lisptests&quot;)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">function(catkin_add_lisptests filename system_name entry_point)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  if(NOT ${ARGC} EQUAL 3)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    message(FATAL_ERROR &quot;catkin_add_lisptests can only have 3 arguments&quot;)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  endif()</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  cmake_parse_arguments(ARG &quot;&quot; &quot;TIMEOUT;WORKING_DIRECTORY&quot; &quot;&quot; ${ARGN})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  if(ARG_TIMEOUT)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    message(WARNING &quot;TIMEOUT argument to catkin_add_lisptests() is ignored&quot;)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  endif()</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  add_lisp_script(${filename} ${system_name} ${entry_point})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  set(output_dir ${CATKIN_DEVEL_PREFIX}/${CATKIN_PACKAGE_BIN_DESTINATION})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  set(script ${output_dir}/${filename})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  set(target _roslisp_${filename})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  set(test_output_dir ${CATKIN_TEST_RESULTS_DIR}/${PROJECT_NAME})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  set(xunit_filename lisptests-${filename}.xml)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  add_dependencies(tests ${target})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  file(MAKE_DIRECTORY ${test_output_dir})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  catkin_run_tests_target(&quot;lisptests&quot; ${target} ${xunit_filename}</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    COMMAND &quot;${script} --gtest_output=xml:${test_output_dir}/${xunit_filename}&quot;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    DEPENDENCIES ${target}</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    WORKING_DIRECTORY ${ARG_WORKING_DIRECTORY})</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">endfunction()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>It takes the same arguments as <code>add_lisp_executable</code>, uses rostest to run the generated executable.</p><p>The whole implementation mentioned in this page can be found in the <a href="https://github.com/wty-andrew/clownbot/tree/master/clownbot_common/testing" target="_blank" rel="noopener noreferrer">clownbot_common</a> package. We should now have a testing setup that integrates well with ROS.</p><div class="footnotes"><hr><ol><li id="fn-1">See <a href="https://github.com/google/googletest/blob/master/googletest/docs/advanced.md#generating-an-xml-report" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://llg.cubic.org/docs/junit/" target="_blank" rel="noopener noreferrer">here</a> for detailed description of the JUnit XML reporting format<a href="#fnref-1" class="footnote-backref">â†©</a></li></ol></div></div></article><div></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#integration-with-rostest" class="table-of-contents__link">Integration with Rostest</a></li><li><a href="#executable-script" class="table-of-contents__link">Executable Script</a></li><li><a href="#integration-with-catkin" class="table-of-contents__link">Integration with Catkin</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Andrew. Built with Docusaurus.</div></div></div></footer></div>
<script src="/clownbot/assets/js/runtime~main.22bc7103.js"></script>
<script src="/clownbot/assets/js/main.a805163a.js"></script>
</body>
</html>